<html>
    <head>
        <title>Utenti</title>
    </head>
    <body>
        <p>Bentornato, <span id="username"></span>. <a onClick="logout()">Logout</a></p>

        <h2>Utenti</h2>
        <table>
            <thead>
                <tr>
                    <th>
                        Username
                    </th>
                    <th>
                        Operazioni
                    </th>
                </tr>
            </thead>
            <tbody>
                <!-- Tabella popolata dinamicamente -->    
            </tbody>
        </table>

        <h2>Aggiungi utente</h2>
        <form id="addUser">
            <input type="text" id="addUser-username" placeholder="Username" />
            <input type="password" id="addUser-password" placeholder="Password" />
            <button type="submit">Aggiungi</button>
        </form>

        <script>
            document.getElementById('username').innerText = localStorage.getItem('username');

            async function logout() {
                const user_id = localStorage.getItem('user_id');
                const token = localStorage.getItem('token');

                const response = await fetch('http://localhost/csc-corso-backend/esercitazione/api/token.php', {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': 'Bearer ' + localStorage.getItem('token'),
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({user_id, token})
                });
                const result = await response.json();

                if (result.success) {
                    window.location.href = "http://localhost/csc-corso-backend/esercitazione/login.html";
                } else {
                    console.log(result.message);
                }
            }

            async function getUsers() {
                const response = await fetch('http://localhost/csc-corso-backend/esercitazione/api/users.php', {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                });
                const result = await response.json();

                if (result.success) {
                    const utenti = result.data;
                    const tbody = document.getElementsByTagName('tbody')[0];
                    
                    tbody.innerHTML = "";

                    utenti.forEach(utente => {
                        var row = "<tr><td>" + utente.username + "</td><td>";
                            if (utente.id != localStorage.getItem('user_id')) {
                                row += "<button onClick='deleteUser(" + utente.id + ", \"" + utente.username + "\")'>Elimina</button>";
                                row += "<button onClick='revokeAccess(" + utente.id + ", \"" + utente.username + "\", \"" + utente.token + "\")'>Revoca Accesso</button>";
                            }
                        row += "</td></tr>";
                        tbody.innerHTML = tbody.innerHTML + row;
                    });
                } else {
                    console.log(result.message);
                }
            }

            async function deleteUser(user_id, username) {
                if (confirm("Vuoi davvero eliminare l'utente " + username + "?")) {
                    const response = await fetch('http://localhost/csc-corso-backend/esercitazione/api/users.php?id=' + user_id, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                    });
                    const result = await response.json();
    
                    if (result.success) {
                        getUsers();
                    } else {
                        console.log(result.message);
                    }
                }
            }

            async function revokeAccess(user_id, username, token) {
                if (confirm("Vuoi davvero revocare l'accesso per l'utente " + username + "?")) {
                    const response = await fetch('http://localhost/csc-corso-backend/esercitazione/api/token.php', {
                        method: 'DELETE',
                        headers: { 
                            'Authorization': 'Bearer ' + localStorage.getItem('token'),
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify({user_id, token})
                    });
                    const result = await response.json();

                    if (result.success) {
                        getUsers();
                    } else {
                        console.log(result.message);
                    }
                }
            }

            document.getElementById('addUser').addEventListener('submit', async function(e) {
                e.preventDefault();

                const username = document.getElementById('addUser-username').value;
                const password = document.getElementById('addUser-password').value;

                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);

                const response = await fetch('http://localhost/csc-corso-backend/esercitazione/api/users.php', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    getUsers();
                } else {
                    console.log(result.message);
                }
            });

            getUsers();
        </script>
    </body>
</html>